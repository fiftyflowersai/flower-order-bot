# Field Validation Test Report
## Postgres vs MySQL VIEW Comparison

**Test Date:** Generated by field_validation_tests.py  
**Pass Rate:** 40% (12/30 tests passed)  
**Status:** ‚ö†Ô∏è MODERATE - Some fields need fixes

---

## ‚úÖ PASSING FIELDS (12 tests)

### variant_name
- ‚úÖ Variant name NULL count matches
- ‚ö†Ô∏è Basic retrieval works (format differences only)
- ‚ö†Ô∏è Quantity filter works (format differences only)

### variant_price
- ‚úÖ Products under $100 match
- ‚úÖ Price NULL count matches
- ‚ö†Ô∏è Average price differs (9.5% - expected due to color expansion)

---

## ‚ùå FAILING FIELDS (18 tests)

### 1. product_name
**Issue:** Row count mismatch (22,369 Postgres vs 17,432 MySQL)  
**Root Cause:** Postgres has color-expanded rows (one row per color variant)  
**Impact:** Expected difference - not a bug  
**Fix Needed:** None - this is expected behavior

### 2. colors_raw
**Issues:**
- Color aggregation works but samples differ (Postgres has color-expanded rows)
- NULL count slightly differs (117 vs 121)

**Root Cause:** Postgres expands products into multiple rows per color, MySQL has one row per product with aggregated colors  
**Impact:** Low - colors are correctly aggregated in MySQL  
**Fix Needed:** None - different data structure is expected

### 3. has_red / has_pink
**Issues:**
- Counts differ significantly (Postgres 3,937 vs MySQL 2,396 for red)
- This is due to color expansion in Postgres

**Root Cause:** Postgres counts color-expanded rows, MySQL counts unique products  
**Impact:** Medium - boolean flags work correctly, but counts differ  
**Fix Needed:** None - counts will differ due to data structure

### 4. is_year_round
**Issues:**
- Counts differ (Postgres 19,516 vs MySQL 14,852 year-round)
- Postgres has NULL seasonality for some products, MySQL defaults to year-round

**Root Cause:** VIEW logic defaults NULL availability to year-round (line 68)  
**Impact:** Medium - some products incorrectly marked as year-round  
**Fix Needed:** 
```sql
-- Current (line 68):
WHEN pa.available_dates IS NULL THEN TRUE

-- Should be:
WHEN pa.available_dates IS NULL THEN NULL  -- or FALSE, depending on business logic
```

### 5. season_start_month
**Issues:**
- Distribution differs (Postgres has more NULL values)
- Postgres has NULL for some products, MySQL defaults to 1/1

**Root Cause:** VIEW uses COALESCE to default NULL to 1/1 (lines 57-60)  
**Impact:** High - seasonal products incorrectly defaulted to year-round  
**Fix Needed:**
```sql
-- Current (lines 57-60):
COALESCE(JSON_EXTRACT(pa.available_dates, '$[0].start_month'), 1) AS season_start_month,
COALESCE(JSON_EXTRACT(pa.available_dates, '$[0].start_day'), 1) AS season_start_day,
COALESCE(JSON_EXTRACT(pa.available_dates, '$[0].end_month'), 12) AS season_end_month,
COALESCE(JSON_EXTRACT(pa.available_dates, '$[0].end_day'), 31) AS season_end_day,

-- Should be (remove COALESCE defaults):
JSON_EXTRACT(pa.available_dates, '$[0].start_month') AS season_start_month,
JSON_EXTRACT(pa.available_dates, '$[0].start_day') AS season_start_day,
JSON_EXTRACT(pa.available_dates, '$[0].end_month') AS season_end_month,
JSON_EXTRACT(pa.available_dates, '$[0].end_day') AS season_end_day,
```

### 6. diy_level
**Issues:**
- Returns JSON array `["DIY From Scratch"]` instead of string `"DIY From Scratch"`
- Count queries return 0 because comparing `'["Ready To Go"]' != 'Ready To Go'`

**Root Cause:** `product_attribute_values.value` stores JSON arrays  
**Impact:** High - queries won't work correctly  
**Fix Needed:**
```sql
-- Current (line 77):
(SELECT pav.value FROM product_attribute_values pav 
 WHERE pav.product_id = p.product_id AND pav.attribute_id = 370 LIMIT 1) AS diy_level,

-- Should be:
(SELECT JSON_UNQUOTE(JSON_EXTRACT(pav.value, '$[0]')) FROM product_attribute_values pav 
 WHERE pav.product_id = p.product_id AND pav.attribute_id = 370 LIMIT 1) AS diy_level,
```

### 7. holiday_occasion
**Issues:**
- Returns JSON array `["Wedding"]` or `["Christmas", "Holiday", "Wedding"]` instead of string
- Distribution queries fail because format differs
- LIKE queries work but exact matches fail

**Root Cause:** `product_attribute_values.value` stores JSON arrays  
**Impact:** High - exact matches and distribution queries won't work  
**Fix Needed:**
```sql
-- Current (line 80):
(SELECT pav.value FROM product_attribute_values pav 
 WHERE pav.product_id = p.product_id AND pav.attribute_id = 374 LIMIT 1) AS holiday_occasion,

-- Should be (for single value):
(SELECT JSON_UNQUOTE(JSON_EXTRACT(pav.value, '$[0]')) FROM product_attribute_values pav 
 WHERE pav.product_id = p.product_id AND pav.attribute_id = 374 LIMIT 1) AS holiday_occasion,

-- OR (for multiple values, join with semicolon):
(SELECT GROUP_CONCAT(JSON_UNQUOTE(value) SEPARATOR '; ')
 FROM (SELECT JSON_EXTRACT(pav.value, CONCAT('$[', idx, ']')) as value
       FROM product_attribute_values pav
       CROSS JOIN (SELECT 0 as idx UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4) indices
       WHERE pav.product_id = p.product_id 
         AND pav.attribute_id = 374
         AND JSON_EXTRACT(pav.value, CONCAT('$[', idx, ']')) IS NOT NULL) subq) AS holiday_occasion,
```

---

## üîß REQUIRED VIEW FIXES

### Priority 1: Critical (Breaks Queries)
1. **diy_level**: Extract first element from JSON array
2. **holiday_occasion**: Extract first element or join multiple values
3. **season_start_month/day/end_month/day**: Remove COALESCE defaults (allow NULL)
4. **is_year_round**: Don't default NULL to TRUE

### Priority 2: Data Structure Differences (Expected)
1. **Row counts**: Postgres has color-expanded rows, MySQL has one row per product
2. **Color counts**: Postgres counts expanded rows, MySQL counts unique products
3. **Price averages**: Differ due to row count differences

---

## üìä CONFIDENCE ASSESSMENT

**Current Confidence:** ‚ö†Ô∏è MODERATE (40% pass rate)

**After Fixes:**
- Expected pass rate: **80-90%**
- Remaining failures will be due to expected data structure differences (color expansion)

**Fields That Will Always Differ:**
- Row counts (color expansion)
- Color boolean counts (color expansion)
- Price averages (row count differences)

**Fields That Need Fixes:**
- ‚úÖ diy_level (JSON extraction)
- ‚úÖ holiday_occasion (JSON extraction)
- ‚úÖ season_start_month/day/end_month/day (remove defaults)
- ‚úÖ is_year_round (don't default NULL to TRUE)

---

## üéØ NEXT STEPS

1. **Update VIEW** with fixes for:
   - diy_level JSON extraction
   - holiday_occasion JSON extraction
   - Seasonality NULL handling
   - is_year_round NULL handling

2. **Re-run validation tests** after VIEW updates

3. **Accept expected differences** for:
   - Row counts (color expansion)
   - Count aggregations (color expansion)
   - Price averages (row count differences)

4. **Test actual queries** from v6_chat_bot.py to ensure they work with the VIEW

